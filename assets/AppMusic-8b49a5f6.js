import{au as it,v as at,G as V,a6 as _t,a7 as rt,a8 as U,$,aa as ut,Q as S,aK as z,o as a,d as _,e as t,H as v,I as dt,p as l,n as P,h as f,g as r,w as A,t as u,aL as F,ah as q,N as m,P as C,F as J,i as O,f as I,J as y,O as ct,Y as mt}from"./index-b17261da.js";import{M as gt}from"./MusicPlayerFull-3be8822d.js";import{_ as j}from"./FormTextarea-04b99bf5.js";import"./parse_colored_row_lrc-4bdcb06e.js";import"./Play-3ef5235b.js";const pt={id:"AppMusic"},ht={class:"app_music"},vt={class:"music_audio content"},ft=["src"],yt={id:"music_settings"},wt={class:"setting_rows"},Vt={class:"settings_group_title"},xt={class:"setting_item"},kt=t("div",{class:"setting_item_name"},[t("h4",null,"下一首播放")],-1),bt={class:"setting_item_action"},$t={class:"setting_item"},Ut=t("div",{class:"setting_item_name"},[t("h4",null,"进度显示方式"),t("p",null,"进度条右侧的时间")],-1),St={class:"setting_item_action"},At={class:"setting_item"},Ft={class:"setting_item_name"},qt={class:"setting_item_action"},Ct=t("h3",{class:"settings_group_title"},"歌词显示",-1),Mt={class:"setting_item"},Nt=t("div",{class:"setting_item_name"},[t("h4",null,"歌词对齐")],-1),Ht={class:"setting_item_action"},Tt={class:"setting_item"},Bt=t("div",{class:"setting_item_name"},[t("h4",null,"中文翻译"),t("p",null,"仅部分歌曲可用")],-1),Dt={class:"setting_item_action"},Et={class:"setting_item"},Rt=t("div",{class:"setting_item_name"},[t("h4",null,"歌词发音"),t("p",null,"仅部分歌曲可用，整句标注罗马音")],-1),zt={class:"setting_item_action"},Pt={class:"setting_item"},Jt=t("div",{class:"setting_item_name"},[t("h4",null,"歌词注音"),t("p",null,"仅部分歌曲可用，仅在汉字上方标注假名")],-1),Ot={class:"setting_item_action"},It=t("h3",{class:"settings_group_title"},"歌词类型",-1),jt=t("p",{class:"settings_group_intro"}," 按照优先级排序，会启用可用且开启的第一项歌词 ",-1),Kt={class:"setting_item"},Lt=t("div",{class:"setting_item_name"},[t("h4",null,"彩色歌词 [Beta]"),t("p",null," 这是一种全新的歌词数据类型，支持使用不同颜色标注不同演唱者，支持日语汉字假名注音，实验中功能，目前仅有少数歌曲支持 ")],-1),Gt={class:"setting_item_action"},Qt={class:"setting_item"},Wt=t("div",{class:"setting_item_name"},[t("h4",null,"逐字滚动歌词"),t("p",null,"仅部分歌曲可用，会增加性能消耗")],-1),Yt={class:"setting_item_action"},Xt=t("div",{class:"setting_item"},[t("div",{class:"setting_item_name"},[t("h4",null,"逐行滚动歌词"),t("p",null,".lrc格式的滚动歌词，有时会有翻译和发音")]),t("div",{class:"setting_item_action"},[t("div",{class:"form_item disabled"},[t("span",{class:"text"},"始终开启")])])],-1),Zt=t("div",{class:"setting_item"},[t("div",{class:"setting_item_name"},[t("h4",null,"纯文本歌词"),t("p",null," .txt格式的歌词，如果确实无法找到滚动歌词才会启用此项 ")]),t("div",{class:"setting_item_action"},[t("div",{class:"form_item disabled"},[t("span",{class:"text"},"始终开启")])])],-1),te=t("h3",{class:"settings_group_title"},"歌词滚动",-1),ee={class:"setting_item"},se={class:"setting_item_name"},ne=t("p",null," 负数表示歌词提前出现，正数表示歌词推迟出现 ",-1),le={class:"setting_item_action"},oe={class:"setting_item"},ie={class:"setting_item_name"},ae=t("p",null," 针对逐字歌词，在歌词偏移的基础上对每个字额外的偏移 ",-1),_e={class:"setting_item_action"},re={class:"settings_group_title"},ue={class:"setting_item"},de=t("div",{class:"setting_item_name"},[t("h4",null,"导航栏"),t("p",null,"仅在单独的播放器页面有效")],-1),ce={class:"setting_item_action"},me={class:"setting_item"},ge={class:"setting_item_name"},pe={class:"setting_item_action"},he={class:"setting_item"},ve=t("div",{class:"setting_item_name"},[t("h4",null,"动态背景 [Beta]")],-1),fe={class:"setting_item_action"},ye={class:"settings_group_title"},we={class:"setting_item"},Ve=t("div",{class:"setting_item_name"},[t("h4",null,"原生音频控件 [Dev]")],-1),xe={class:"setting_item_action"},ke={key:0,class:"lrc_raw"},be={class:"lrc_raw_menu"},$e=["onClick"],Ue={key:0,class:"menu_item disabled"},Se=t("hr",null,null,-1),Ae=t("div",{class:"menu_item"},"添加歌词",-1),Fe=t("div",{class:"menu_item"},"解析当前歌词",-1),qe=t("div",{class:"menu_item"},"重新获取歌词",-1),Ce={class:"lrc_raw_content"},Me={key:0,class:"lrc_data_menu"},Ne=["onClick"],He={key:2,class:"kinput ktextarea",disabled:""},Te={key:1,style:{"text-align":"center","margin-top":"20px"}},Be={key:0,class:"song_meta_box"},De=t("b",null,"Source",-1),Ee=t("b",null,"Key",-1),Re=t("hr",null,null,-1),ze=t("b",null,"歌曲 ID",-1),Pe=t("b",null,"网易云歌曲 ID",-1),Je={key:0},Oe=["href"],Ie={key:1},je=t("hr",null,null,-1),Ke=t("b",null,"歌名",-1),Le=t("b",null,"副歌名",-1),Ge=t("b",null,"艺人",-1),Qe=t("b",null,"专辑",-1),We=t("b",null,"封面",-1),Ye=t("b",null,"歌曲时长 (s)",-1),Xe=t("hr",null,null,-1),Ze=t("b",null,"当前音频",-1),ts=t("b",null,"当前音频时长 (s)",-1),es=t("hr",null,null,-1),ss={key:0},ns=t("b",null,"歌曲索引",-1),ls={key:1,style:{"text-align":"center","margin-top":"20px"}},ds={__name:"AppMusic",setup(os){const e=it(),M=at(),g=V(0),x=V("text"),N=V(null);_t(()=>{e.audio_el=N.value}),rt(()=>{e.audio_el=null,e.stop_play_song(),e.queue=[]}),U(()=>e.settings.volume,n=>{e.audio_el&&(e.audio_el.volume=n)});function K(){var n=document.documentElement;n.requestFullscreen?n.requestFullscreen():n.msRequestFullscreen?(n=document.body,n.msRequestFullscreen()):n.mozRequestFullScreen?n.mozRequestFullScreen():n.webkitRequestFullScreen&&n.webkitRequestFullScreen()}function H(){console.log(JSON.parse(JSON.stringify(e.current_song)))}async function L(){let n="";e.current_song._title_cn&&(n=JSON.stringify({zh:e.current_song._title_cn}));const s=await ct("/archive/music/new_song.php",{tokenid:await mt(),title:e.current_song.title,title_t:n,_artists_name:e.current_song._artists_name,_album_name:e.current_song._album_name,cover_url:e.current_song.cover_url,ncm_id:e.current_song.ncm_id,audio_duration:e.current_song.song_duration});if(console.log("save_song_meta",s),s.status!="success"){S({message:"保存失败",status:"error"});return}else S({message:"保存成功",status:"success"})}U(()=>e.current_song,(n,s)=>{G(n,s)});async function G(n,s){if(n!=null&&n.audio_url&&(n==null?void 0:n.audio_url)==(s==null?void 0:s.audio_url)){console.log("音频相同, 不重新加载"),e.seek_to_begin(),B(),await T();return}if(e.playing_current_time=0,e.playing_duration=-1,!n){e.current_song_state="none";return}e.current_song_state="loading";try{B(),await Q(),await T(),W()}catch(o){console.log(o),Z()}}async function Q(){var s;const n=e.current_song.audio;if(!n.ready&&n.source){switch(n.source.type){case"ncm":{const o=await $("/ncm/song/",{id:n.source.data});if(o.code!=200)throw console.log("获取歌曲音频失败",o),new Error("step_get_audio_url");if(o.data&&((s=o.data[0])!=null&&s.url)){e.current_song.audio_url=o.data[0].url.replace("http://","https://");return}}break}throw console.log("获取歌曲音频失败"),new Error("step_get_audio_url")}}async function T(){var o,w,h,c,b,D,E,R;const n=e.current_song.lrc,s=e.current_song;if(!n.ready&&n.source)switch(n.source.type){case"kloudy":{const i=await $("/archive/music/get_song_detail.php",{song_id:n.source.data});if(i.status!="success"){n.ready=!0;return}const d=i.data.lrc;s.lrc_data=[],d.lrc_row_colored&&s.lrc_data.push({type:"colored",data:{text:d.lrc_row_colored,trans:d.lrc_row_colored_cn,line_time:d.lrc_row_colored_time,chara:d.lrc_row_colored_chara}}),d.lrc_ttml&&s.lrc_data.push({type:"ttml",data:{text:d.lrc_ttml}}),d.lrc_word&&s.lrc_data.push({type:"word",data:{text:d.lrc_word,trans:d.lrc_word_cn,roma:d.lrc_word_roma}}),d.lrc_row&&s.lrc_data.push({type:"row",data:{text:d.lrc_row,trans:d.lrc_row_cn,roma:d.lrc_row_roma}}),d.lrc_plain_text&&s.lrc_data.push({type:"plain_text",data:{text:d.lrc_plain_text}}),n.ready=!0;return}case"meting":{const i=await $(n.source.data);typeof i=="object"?s.lrc_data=[{type:"row",data:{text:i.lyric,trans:i.tlyric}}]:typeof i=="string"?s.lrc_data=[{type:"row",data:{text:i}}]:s.lrc_data=[],n.ready=!0;return}case"ncm":{const i=await $("/ncm/lyric/?id="+n.source.data);s.lrc_data=[],(o=i==null?void 0:i.yrc)!=null&&o.lyric&&s.lrc_data.push({type:"word",data:{text:(w=i==null?void 0:i.yrc)==null?void 0:w.lyric,trans:(h=i==null?void 0:i.ytlrc)==null?void 0:h.lyric,roma:(c=i==null?void 0:i.yromalrc)==null?void 0:c.lyric}}),(b=i==null?void 0:i.lrc)!=null&&b.lyric&&s.lrc_data.push({type:"row",data:{text:(D=i==null?void 0:i.lrc)==null?void 0:D.lyric,trans:(E=i==null?void 0:i.tlyric)==null?void 0:E.lyric,roma:(R=i==null?void 0:i.romalrc)==null?void 0:R.lyric}}),n.ready=!0;return}}}function B(){"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:e.current_song.title,artist:e.current_song._artists_name,album:e.current_song._album_name,artwork:[{src:e.current_song.cover_url,type:"image/jpg"}]}),navigator.mediaSession.setActionHandler("play",e.play_pause),navigator.mediaSession.setActionHandler("pause",e.play_pause),navigator.mediaSession.setActionHandler("previoustrack",e.play_prev_song),navigator.mediaSession.setActionHandler("nexttrack",e.play_next_song),navigator.mediaSession.setActionHandler("seekbackward",e.seek_backward),navigator.mediaSession.setActionHandler("seekforward",e.seek_forward),navigator.mediaSession.setActionHandler("seekto",n=>{e.seek_to_time(n.seekTime)}))}function W(){ut(()=>{e.audio_el.volume=e.settings.volume,e.audio_el.play(),Y()})}function Y(){X=5}let X=5;function Z(){e.current_song&&(e.current_song_state="none",S({message:"无法播放此歌曲: "+e.current_song.title,status:"error",group:"music_play_error"+e.current_song.ncm_id}))}function tt(){e.current_song_state="playing"}function et(){e.current_song_state="paused",e.audio_el&&(e.playing_current_time=e.audio_el.currentTime)}function st(){e.audio_el&&(e.playing_duration=e.audio_el.duration)}function nt(){e.play_next_song()}function lt(){n(5);function n(s){s>0&&(e.audio_el&&(e.playing_current_time=e.audio_el.currentTime),setTimeout(()=>{n(s-1)},50))}}function ot(n){}const k=V(!1),p=V(0);return U(()=>e.open.full_player,n=>{n?(k.value=!0,z.to(p,{value:100,duration:.5,delay:.1})):(z.to(p,{value:0,duration:.5}),setTimeout(()=>{k.value=!1},500))}),(n,s)=>(a(),_("div",pt,[t("div",ht,[v(t("div",vt,[t("audio",{ref_key:"audio_el",ref:N,controls:"",src:l(e).current_song?l(e).current_song.audio_url:"",onPlaying:tt,onPause:et,onDurationchange:st,onEnded:nt,onTimeupdate:lt,onError:ot},null,40,ft)],512),[[dt,l(e).settings.show_controls]]),k.value?(a(),_("div",{key:0,class:"full_player_bg",style:P({bottom:`${p.value}%`,opacity:`${p.value/100}`})},null,4)):f("",!0),k.value?(a(),_("div",{key:1,class:"full_player_container",style:P({top:`${100-p.value}%`})},[r(gt,{closeable:"",modelValue:p.value,"onUpdate:modelValue":s[0]||(s[0]=o=>p.value=o)},null,8,["modelValue"])],4)):f("",!0),r(C,{modelValue:l(e).open.settings,"onUpdate:modelValue":s[15]||(s[15]=o=>l(e).open.settings=o),title:n.$text("player.settings")},{default:A(()=>[t("div",yt,[t("div",wt,[t("h3",Vt,u(n.$text("player.play")),1),t("div",xt,[kt,t("div",bt,[r(F,{modelValue:l(e).settings.next_song,"onUpdate:modelValue":s[1]||(s[1]=o=>l(e).settings.next_song=o),translate:!1,options:{list:"顺序播放",random:"随机播放",list_loop:"列表循环",single_loop:"单曲循环",stop:"停止播放"}},null,8,["modelValue","options"])])]),t("div",$t,[Ut,t("div",St,[r(F,{modelValue:l(e).settings.time_display,"onUpdate:modelValue":s[2]||(s[2]=o=>l(e).settings.time_display=o),translate:!0,options:{duration:"player.display_duration",left:"player.display_time_left"}},null,8,["modelValue","options"])])]),t("div",At,[t("div",Ft,[t("h4",null,u(n.$text("player.volume")),1)]),t("div",qt,[r(q,{modelValue:l(e).settings.volume,"onUpdate:modelValue":s[3]||(s[3]=o=>l(e).settings.volume=o),title:n.$text("player.volume"),max:1,step:.01},null,8,["modelValue","title"])])]),Ct,t("div",Mt,[Nt,t("div",Ht,[r(F,{modelValue:l(e).settings.lrc_align,"onUpdate:modelValue":s[4]||(s[4]=o=>l(e).settings.lrc_align=o),translate:!0,options:{left:"player.lrc_left",center:"player.lrc_center"}},null,8,["modelValue","options"])])]),t("div",Tt,[Bt,t("div",Dt,[r(m,{modelValue:l(e).settings.show_translate,"onUpdate:modelValue":s[5]||(s[5]=o=>l(e).settings.show_translate=o),on_text:n.$text("settings.showed"),off_text:n.$text("settings.hidden")},null,8,["modelValue","on_text","off_text"])])]),t("div",Et,[Rt,t("div",zt,[r(m,{modelValue:l(e).settings.show_roma,"onUpdate:modelValue":s[6]||(s[6]=o=>l(e).settings.show_roma=o),on_text:n.$text("settings.showed"),off_text:n.$text("settings.hidden")},null,8,["modelValue","on_text","off_text"])])]),t("div",Pt,[Jt,t("div",Ot,[r(m,{modelValue:l(e).settings.show_ruby,"onUpdate:modelValue":s[7]||(s[7]=o=>l(e).settings.show_ruby=o),on_text:n.$text("settings.showed"),off_text:n.$text("settings.hidden")},null,8,["modelValue","on_text","off_text"])])]),It,jt,t("div",Kt,[Lt,t("div",Gt,[r(m,{modelValue:l(e).settings.colored_lrc,"onUpdate:modelValue":s[8]||(s[8]=o=>l(e).settings.colored_lrc=o)},null,8,["modelValue"])])]),t("div",Qt,[Wt,t("div",Yt,[r(m,{modelValue:l(e).settings.word_lrc,"onUpdate:modelValue":s[9]||(s[9]=o=>l(e).settings.word_lrc=o)},null,8,["modelValue"])])]),Xt,Zt,te,t("div",ee,[t("div",se,[t("h4",null,u(n.$text("player.lrc_row_offset")),1),ne]),t("div",le,[r(q,{modelValue:l(e).settings.lrc_row_offset,"onUpdate:modelValue":s[10]||(s[10]=o=>l(e).settings.lrc_row_offset=o),title:n.$text("player.lrc_row_offset"),overflow:"",min:-2,max:2,step:.01,rear_unit:"s"},null,8,["modelValue","title"])])]),t("div",oe,[t("div",ie,[t("h4",null,u(n.$text("player.lrc_word_offset")),1),ae]),t("div",_e,[r(q,{modelValue:l(e).settings.lrc_word_offset,"onUpdate:modelValue":s[11]||(s[11]=o=>l(e).settings.lrc_word_offset=o),title:n.$text("player.lrc_word_offset"),overflow:"",min:-2,max:2,step:.01,rear_unit:"s"},null,8,["modelValue","title"])])]),t("h3",re,u(n.$text("settings.display")),1),t("div",ue,[de,t("div",ce,[r(m,{modelValue:l(e).full_player_show.header,"onUpdate:modelValue":s[12]||(s[12]=o=>l(e).full_player_show.header=o),on_text:n.$text("settings.showed"),off_text:n.$text("settings.hidden")},null,8,["modelValue","on_text","off_text"])])]),t("div",me,[t("div",ge,[t("h4",null,u(n.$text("settings.fullscreen"))+" [Beta] ",1),t("p",null,u(n.$text("settings.fullscreen_info")),1)]),t("div",pe,[t("button",{class:"kbutton plain",onClick:K},u(n.$text("settings.enter_fullscreen")),1)])]),t("div",he,[ve,t("div",fe,[r(m,{modelValue:l(e).settings.bg_ani,"onUpdate:modelValue":s[13]||(s[13]=o=>l(e).settings.bg_ani=o)},null,8,["modelValue"])])]),t("h3",ye,u(n.$text("settings.dev_settings")),1),t("div",we,[Ve,t("div",xe,[r(m,{modelValue:l(e).settings.show_controls,"onUpdate:modelValue":s[14]||(s[14]=o=>l(e).settings.show_controls=o),on_text:n.$text("settings.showed"),off_text:n.$text("settings.hidden")},null,8,["modelValue","on_text","off_text"])])])])])]),_:1},8,["modelValue","title"]),r(C,{modelValue:l(e).open.lrc,"onUpdate:modelValue":s[17]||(s[17]=o=>l(e).open.lrc=o),title:"原始歌词文件"},{default:A(()=>{var o,w;return[l(e).current_song?(a(),_("div",ke,[t("div",be,[(a(!0),_(J,null,O(l(e).current_song.lrc_data,(h,c)=>(a(),_("div",{class:I(["menu_item",{active:g.value==c}]),onClick:b=>g.value=c},u(h.type),11,$e))),256)),l(e).current_song.lrc_data.length==0?(a(),_("div",Ue," 无可用歌词 ")):f("",!0),Se,Ae,Fe,qe,t("div",{class:"menu_item",onClick:H}," 显示信息 ")]),t("div",Ce,[l(e).current_song.lrc_data[g.value]?(a(),_("div",Me,[(a(!0),_(J,null,O((o=l(e).current_song.lrc_data[g.value])==null?void 0:o.data,(h,c)=>(a(),_("div",{class:I(["lrc_data_item",{active:x.value==c}]),onClick:b=>x.value=c},u(c)+" ",11,Ne))),256))])):f("",!0),(w=l(e).current_song.lrc_data[g.value])!=null&&w.data?v((a(),_("textarea",{key:1,class:"kinput ktextarea","onUpdate:modelValue":s[16]||(s[16]=h=>l(e).current_song.lrc_data[g.value].data[x.value]=h)},`\r
						`,512)),[[y,l(e).current_song.lrc_data[g.value].data[x.value]]]):(a(),_("textarea",He))])])):(a(),_("p",Te,u(n.$text("player.not_playing")),1))]}),_:1},8,["modelValue"]),r(C,{modelValue:l(e).open.meta,"onUpdate:modelValue":s[25]||(s[25]=o=>l(e).open.meta=o),title:"歌曲元数据"},{default:A(()=>[l(e).current_song?(a(),_("div",Be,[t("p",null,[De,t("span",null,u(l(e).current_song.song_source),1)]),t("p",null,[Ee,t("span",null,u(l(e).current_song.song_key),1)]),Re,t("p",null,[ze,v(t("input",{class:"kinput","onUpdate:modelValue":s[18]||(s[18]=o=>l(e).current_song.song_id=o),placeholder:"N/A"},null,512),[[y,l(e).current_song.song_id]])]),t("p",null,[Pe,l(e).current_song.ncm_id?(a(),_("span",Je,[t("a",{class:"with_underline external_link",href:"https://music.163.com/#/song?id="+l(e).current_song.ncm_id,target:"_blank"},u(l(e).current_song.ncm_id),9,Oe)])):(a(),_("span",Ie,"N/A"))]),je,t("p",null,[Ke,v(t("input",{class:"kinput","onUpdate:modelValue":s[19]||(s[19]=o=>l(e).current_song.title=o)},null,512),[[y,l(e).current_song.title]])]),t("p",null,[Le,v(t("input",{class:"kinput","onUpdate:modelValue":s[20]||(s[20]=o=>l(e).current_song._title_cn=o)},null,512),[[y,l(e).current_song._title_cn]])]),t("p",null,[Ge,v(t("input",{class:"kinput","onUpdate:modelValue":s[21]||(s[21]=o=>l(e).current_song._artists_name=o)},null,512),[[y,l(e).current_song._artists_name]])]),t("p",null,[Qe,v(t("input",{class:"kinput","onUpdate:modelValue":s[22]||(s[22]=o=>l(e).current_song._album_name=o)},null,512),[[y,l(e).current_song._album_name]])]),t("p",null,[We,r(j,{modelValue:l(e).current_song.cover_url,"onUpdate:modelValue":s[23]||(s[23]=o=>l(e).current_song.cover_url=o)},null,8,["modelValue"])]),t("p",null,[Ye,t("span",null,u(l(e).current_song.song_duration||"N/A"),1)]),Xe,t("p",null,[Ze,r(j,{modelValue:l(e).current_song.audio_url,"onUpdate:modelValue":s[24]||(s[24]=o=>l(e).current_song.audio_url=o)},null,8,["modelValue"])]),t("p",null,[ts,t("span",null,u(l(e).playing_duration),1)]),es,l(e).queue&&l(e).queue.length>0?(a(),_("p",ss,[ns,t("span",null,u(l(e).current_song_index+1)+" / "+u(l(e).queue.length),1)])):f("",!0),l(M).is_admin?(a(),_("button",{key:1,class:"kbutton",onClick:H}," 显示信息 ")):f("",!0),l(M).is_admin?(a(),_("button",{key:2,class:"kbutton plain",onClick:L}," 保存歌曲元数据 ")):f("",!0)])):(a(),_("p",ls,u(n.$text("player.not_playing")),1))]),_:1},8,["modelValue"])])]))}};export{ds as default};
